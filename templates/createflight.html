<!--INDY CAF Warbird Booking-->
<!-- Create fl -->
<!--Jim Olivi 2022-->

{% include "header.html" %}
<body xmlns="http://www.w3.org/1999/html">
<script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>

<form method="POST" action="{{ url_for('createflight') }}">
    {{ form.csrf_token }}
    {{ form.flight_id }}

    <div class="container-fluid p-1">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="row align-items-start">
            <div class="col">
                <div id="spinner-saving" style="display:none">
                    <div class="spinner-border text-success"></div>
                    <span id="saving-message">Saving Flight Info.</span>
                </div>
                <h2 class="card-title">Manage a Flight</h2>
                <div id="spinner-get-airport" style="display:none">
                    <div class="spinner-border text-success"></div>
                    <span id="gettingInfo">Getting airport info.</span>
                </div>
                <!-- Airport code, name and city -->
                <div class="row align-items-start">
                    {{ form.airport_code }}
                    {{ form.airport_name }}{{ form.airport_city }}
                    <div id="total_flight_time">
                        <div class="col-sm-12">
                            {{ form.flight_time.label }}
                            {{ form.flight_time }}
                        </div>
                        <div class="col-sm-12">
                            {{ form.end_flight_time.label }}
                            {{ form.end_flight_time }}
                        </div>
                    </div>
                </div>
                <!-- Crew List -->
                <li id="crew_list_template" hidden>
                    {{ form.crew_selection }}: {{ form.crewPosition }}
                </li>
                <h4>Below is the list of assigned crew.</h4>
                <p class="help-text">To add crew, tap the "Add Crew" button. To remove crew, blank out the crew position.</p>
                <ul class="crew-list">
                    {% for crew in crew_list: %}
                    <!--Crew names and crew positions are added here.-->
                    <li class="crew-entry">
                        <select name="crew">
                            <option value={{ crew.colonel_number }}>{{ crew.first_name }} {{ crew.last_name }}</option>
                            {% for selection in crew_selection %}
                            {% if selection[0] != "Select" %}
                            <option value={{ selection[0] }}>{{ selection[1] }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <input name="crewPosition" placeholder="Crew Position" type="text" value={{crew.crew_position}}>
                    </li>
                    {% endfor %}
                </ul>
                <button id="btn_add_crew" type="button" class="btn btn-outline-secondary">Add Crew</button>
                <!--    Submit Button                        -->
                <div class="col">
                    <p class="help-text">If you are duplicating a flight, don't forget to change the flight time, if you have not already.</p>
                    <button id="btn_add_flight" type="submit" class="btn btn-primary">Add/Duplicate Flight</button>
                    <button id="btn_update_flight" type="button" class="btn btn-warning">Update Flight</button>
                </div>
            </div>
            <div class="col-sm-6">
                <!--    Aircraft Name and Photo                        -->

                <label for="aircraft_name">
                    <h3>Select an aircraft</h3>
                </label>
                <div id="spinner-get-plane-image" style="display:none">
                    <div class="spinner-border text-success"></div>
                    <span id="gettingInfo">Getting airplane image.</span>
                </div>
                <select id="aircraft_name" name="aircraft_name" onchange="DisplayAircraft()">
                    {% for airplane in airplanes: %}
                    <option value={{ airplane[0] }} data-image={{ airplane[2] }}
                    >{{ airplane[1] }}
                    </option>
                    {% endfor %}
                </select>
                <img id="aircraftimage" src="" class="img-fluid" alt="Aircraft Image">
                <p class="help-text">To add a seat, tap the "Add Seat" button.</p>
                <p class="help-text">To remove a seat, blank out the seat name. If you remove a seat that has a
                    passenger assignment, contact the passenger for re-assignment or refund.</p>
                <ul class="seat-list">
                    <!--Seat detail are added here.-->
                    {% for seat in seatList: %}
                    <li class="seat-entry">
                        <input type='text' name='seat_name' placeholder='Seat Name' value={{ seat['seat_name'] }}>
                        <input type='number' name='seat_price' placeholder='Seat Price' value={{ seat['seat_price'] }}>
                    </li>
                    {% endfor %}
                </ul>
                <button id="btn_add_seat" type="button" class="btn btn-outline-secondary">Add Seat</button>
            </div>
        </div>
    </div>
</form>
</body>

{% include "footer.html" %}
<!--Script to fetch and display airport name and city-->
<script>
    function DisplayAircraft() {
        $("#spinner-get-plane-image").show();
        const file = $("#aircraft_name option:selected").data("image")
        if (file != "Select" && !!file) {
            const path = `static/images/${file}`
            $("#aircraftimage").attr("src", path)
        }
        $("#spinner-get-plane-image").hide();
    }

    // See if we can display an aircraft photo on startup.
    $(document).ready(() => {
        console.log("Window Loaded")
        DisplayAircraft()

        if ($("#flight_id").val() == "") {
            $("#btn_update_flight").prop("disabled", true)
            console.log("Disable Update")
        } else {
            $("#btn_update_flight").prop("disabled", false)
            console.log("Ensable Update")
        }
    })

    // Listen to the airplane selector, matches the Flask form SelectField object.
    // Putting the image file name in the .img object triggers a get to the server.
    $('#aircraft_name').change(function () {
        DisplayAircraft()
    })

    $("#airport_code").change(function () {
        $("#spinner-get-airport").show();
        const airportCode = $("#airport_code").val()
        const user_url = "/getairport/" + airportCode
        fetch(user_url)
            .then((response) => response.json())
            .then((airport_obj) => {
                $("#airport_name").val(airport_obj.name)
                $("#airport_city").val(airport_obj.city)
            }).catch((error) => {
            console.log(error)
        })
        $("#spinner-get-airport").hide();
    })

    $("#total_flight_time").change(function () {
        const start_flight_time = $("#flight_time").val()
        const end_flight_time = $("#end_flight_time").val()

    })

    // Display the spinner indicating saving the flight
    $('#add_a_flight').on('click', () => {
        $("#spinner-saving").show();
    })

    $("#btn_add_crew").on('click', () => {
        const el = $("#crew_list_template").clone()
        el.addClass("crew")
        el.attr("name", "crew")
        el.removeAttr("id")
        el.removeAttr("hidden")
        el.appendTo(".crew-list")
    })

    $("#btn_add_seat").click(() => {
        $('.seat-list').append("<li><input type='text' name='seat_name' placeholder='Seat Name' value=''><input type='number' name='seat_price' placeholder='Seat Price' value=''></li>")
    })

    $("#btn_update_flight").click(() => {
        console.log("Update Flight button.")
        const flightkey = $('#flight_id').val()
        const url ='/createflight?flightkey=' + flightkey
        $('form').attr('action', url).submit()
    })
</script>